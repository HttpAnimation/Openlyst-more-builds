name: Update AUR Packages

on:
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to update (leave empty for all)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - klit-bin
          - doudou-bin
          - finar-bin
      force:
        description: 'Force update even if version matches'
        required: false
        default: false
        type: boolean
      dry_run:
        description: 'Dry run (do not push changes)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read

env:
  PYTHON_VERSION: '3.11'

jobs:
  update-aur:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Setup SSH key for AUR
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          
          # Write SSH key preserving newlines
          printf '%s\n' "$AUR_SSH_KEY" > ~/.ssh/aur_ed25519
          chmod 600 ~/.ssh/aur_ed25519
          
          # Verify the key format
          echo "SSH key first line: $(head -1 ~/.ssh/aur_ed25519)"
          echo "SSH key last line: $(tail -1 ~/.ssh/aur_ed25519)"
          echo "SSH key line count: $(wc -l < ~/.ssh/aur_ed25519)"
          
          # Configure SSH for AUR
          cat > ~/.ssh/config << 'SSHCONFIG'
          Host aur.archlinux.org
            IdentityFile ~/.ssh/aur_ed25519
            User aur
            StrictHostKeyChecking accept-new
          SSHCONFIG
          # Remove leading whitespace from config
          sed -i 's/^[[:space:]]*//' ~/.ssh/config
          chmod 600 ~/.ssh/config
          
          # Debug: Show config content
          echo "=== SSH Config ==="
          cat ~/.ssh/config
          echo "=================="
          
          # Debug: Check SSH key validity
          ssh-keygen -l -f ~/.ssh/aur_ed25519 || echo "Warning: Could not read key fingerprint"
          
          # Test SSH connection (will add host to known_hosts)
          ssh -vT aur@aur.archlinux.org 2>&1 | head -50 || true
      
      - name: Configure Git
        run: |
          git config --global user.email "httpanimations@proton.me"
          git config --global user.name "HttpAnimations"
      
      - name: Update AUR packages
        id: update
        run: |
          # Build command arguments
          ARGS=""
          
          if [ "${{ github.event.inputs.package }}" != "" ]; then
            ARGS="--package ${{ github.event.inputs.package }}"
          else
            ARGS="--all"
          fi
          
          if [ "${{ github.event.inputs.force }}" == "true" ]; then
            ARGS="$ARGS --force"
          fi
          
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            ARGS="$ARGS --dry-run"
          fi
          
          echo "Running: python update_aur_packages.py $ARGS --verbose"
          python update_aur_packages.py $ARGS --verbose
      
      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/aur_ed25519
          
  notify-on-failure:
    needs: update-aur
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: Create failure notification
        run: |
          echo "::error::AUR package update failed. Check the logs for details."
